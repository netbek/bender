/*
 * bender
 * 
 * @author Hein Bekker <hein@netbek.co.za>
 * @copyright (c) 2016 Hein Bekker
 * @license http://www.gnu.org/licenses/agpl-3.0.txt AGPLv3
 */
!function(a,b){function c(){this.flags={init:!1},this.config={},this.ratios=[],this.url=b,this.$frames=b;for(var a,c=[[10,16],[10,15],[9,16],[3,4]],d=0,e=c.length;e>d;d++)a=c[d],this.ratios.push({width:a[0],height:a[1],ratio:a[0]/a[1],name:a[0]+":"+a[1]}),a[0]!==a[1]&&this.ratios.push({width:a[1],height:a[0],ratio:a[1]/a[0],name:a[1]+":"+a[0]})}a.bender||(c.prototype.getRatioName=function(a,c){for(var d,e=Number(a)/Number(c),f=0,g=this.ratios.length;g>f;f++)if(d=this.ratios[f],d.ratio===e)return d.name;return b},c.prototype.init=function(a){if(!this.flags.init){var c=this;this.flags.init=!0;var d={debug:!1,sitemap:b,sitemapUrl:b,sitemapBaseUrl:b,baseUrl:"",cache:!0,cacheQueryParam:"ts",screens:[]};_.defaults(this.config,a,d);for(var e,f,g,h=jQuery("#frames > ul"),i="",j=0,k=this.config.screens.length;k>j;j++)e=this.config.screens[j],f=e.split("-"),g=c.getRatioName(f[0],f[1]),i+="<li><p>"+f[0]+" x "+f[1]+(g?", "+g:"")+'</p><iframe class="f f-'+f[0]+"-"+f[1]+'"></iframe></li>';if(h.append(i),this.$frames=jQuery("iframe"),_.isNil(this.config.sitemap)){if(_.isNil(this.config.sitemapUrl))throw new Error("Either `sitemap` or `sitemapUrl` should be defined in config.");jQuery.ajax({cache:!1,method:"GET",dataType:"xml",url:this.config.sitemapUrl,error:function(){throw new Error("Could not load sitemap.")},success:function(a,b,d){c.config.sitemap={},jQuery(a).find("url").each(function(){var a=jQuery(this).find("loc").text();if(a.substr(0,c.config.sitemapBaseUrl.length)===c.config.sitemapBaseUrl){var b=a=a.substr(c.config.sitemapBaseUrl.length);""===b&&(b="/"),a=c.config.baseUrl+a,c.config.sitemap[a]=b}}),c.loadFrames()}})}else this.loadFrames()}},c.prototype.loadFrames=function(){if(this.flags.init){var a,b,c,d=this,e=jQuery("#menu"),f=jQuery("<ul />"),g=[];for(a in this.config.sitemap)this.config.sitemap.hasOwnProperty(a)&&g.push(a);for(g.sort(),c=g.length,b=0;c>b;b++){a=g[b],_.isNil(this.config.firstUrl)&&(this.config.firstUrl=a);var h=jQuery('<a href="'+a+'">'+this.config.sitemap[a]+"</a>").on("click.bender",function(a){d.setUrl(jQuery(this).attr("href")),a.preventDefault()}),i=jQuery("<li />");i.append(h),f.append(i)}jQuery('a[href="#"]',e).on("click.bender",function(a){a.preventDefault()}),c&&(jQuery("li.sitemap",e).append(f),d.setUrl(this.config.firstUrl)),e.removeClass("hidden").superfish({delay:100,speed:100})}},c.prototype.setUrl=function(a){if(this.flags.init){if(_.isNil(a))throw new Error("`url` is required");var b=!1===this.config.cache;this.url=this.setCacheQueryParam(a,this.config.cache),b&&(this.$frames.off("load.bender"),this.$frames.on("load.bender",function(){jQuery(this).off("load.bender"),this.contentWindow.location.reload(!0)})),this.$frames.attr("src",this.url)}},c.prototype.isEqualUrl=function(a,b){var c=this.removeCacheQueryParam(a),d=this.removeCacheQueryParam(b);return _.isEqual(c,d)},c.prototype.removeCacheQueryParam=function(a){var b=new Url(a);return _.isFunction(b.query[this.config.cacheQueryParam])||delete b.query[this.config.cacheQueryParam],b},c.prototype.setCacheQueryParam=function(a,b){var c;if(!1!==b)return a;c=Date.now();var d=new Url(a);return d.query[this.config.cacheQueryParam]=c,d.toString()},a.bender=new c)}(this),function(a,b){var c=setInterval(function(){a._&&a.bender&&a.benderConfig&&a.jQuery&&a.Url&&(clearInterval(c),c=null,a.bender.init(a.benderConfig))})}(this);